{{block "content" .}}

<div class="page-header with-actions">
    <div>
        <h1>Application Tracker</h1>
        <p class="subtitle">Manage your job applications</p>
    </div>
    <button class="btn btn-primary" onclick="showAddForm()">Add Application</button>
</div>

<!-- Stats -->
<div class="stats-grid compact">
    <div class="stat-card">
        <div class="stat-value">{{.Stats.Applied}}</div>
        <div class="stat-label">Applied</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Stats.Interviewing}}</div>
        <div class="stat-label">Interviewing</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Stats.Offer}}</div>
        <div class="stat-label">Offers</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{.Stats.Rejected}}</div>
        <div class="stat-label">Rejected</div>
    </div>
</div>

<!-- Applications Table -->
<div class="section">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Company</th>
                    <th>Role</th>
                    <th>Applied Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .Applications}}
                <tr>
                    <td class="company-cell">
                        <strong>{{.Company}}</strong>
                        {{if .HiringManager}}<br><small>{{.HiringManager}}</small>{{end}}
                    </td>
                    <td>{{.Role}}</td>
                    <td>{{.AppliedDate}}</td>
                    <td>
                        <select class="status-select {{.Status | lower}}" 
                                onchange="updateStatus('{{.ID}}', this.value)">
                            <option value="Applied" {{if eq .Status "Applied"}}selected{{end}}>Applied</option>
                            <option value="Interviewing" {{if eq .Status "Interviewing"}}selected{{end}}>Interviewing</option>
                            <option value="Offer" {{if eq .Status "Offer"}}selected{{end}}>Offer</option>
                            <option value="Rejected" {{if eq .Status "Rejected"}}selected{{end}}>Rejected</option>
                        </select>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-icon" onclick="editApplication('{{.ID}}')" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-icon danger" onclick="deleteApplication('{{.ID}}')" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="5" class="empty-table">
                        <div class="empty-state">
                            <h3>No applications yet</h3>
                            <p>Start tracking your job applications</p>
                            <button class="btn btn-primary" onclick="showAddForm()">Add Your First Application</button>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Application Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Application</h3>
            <button class="modal-close" onclick="hideAddForm()">√ó</button>
        </div>
        <form id="addForm" onsubmit="saveApplication(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Company *</label>
                        <input type="text" class="form-input" name="company" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <input type="text" class="form-input" name="role" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Applied Date *</label>
                        <input type="date" class="form-input" name="applied_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="Applied">Applied</option>
                            <option value="Interviewing">Interviewing</option>
                            <option value="Offer">Offer</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Hiring Manager</label>
                        <input type="text" class="form-input" name="hiring_manager">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" name="notes" rows="3" placeholder="Any additional notes..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="hideAddForm()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Application</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddForm() {
    const form = document.getElementById('addForm');
    form.reset();
    document.getElementById('addModal').classList.add('active');
}

function hideAddForm() {
    document.getElementById('addModal').classList.remove('active');
}

function saveApplication(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Set default date if not provided
    if (!data.applied_date) {
        data.applied_date = new Date().toISOString().split('T')[0];
    }
    
    fetch('/tracker/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            showNotification('Application added successfully!', 'success');
            hideAddForm();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.error || 'Failed to save application', 'error');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
    });
}

function updateStatus(appId, status) {
    fetch(`/tracker/${appId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status !== 'success') {
            showNotification('Failed to update status', 'error');
            location.reload(); // Reload to reset to correct state
        } else {
            showNotification('Status updated successfully!', 'success');
        }
    })
    .catch(error => {
        showNotification('Error: ' + error.message, 'error');
        location.reload();
    });
}

function deleteApplication(appId) {
    if (confirm('Are you sure you want to delete this application?')) {
        fetch(`/tracker/${appId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showNotification('Application deleted successfully!', 'success');
                location.reload();
            } else {
                showNotification('Failed to delete application', 'error');
            }
        })
        .catch(error => {
            showNotification('Error: ' + error.message, 'error');
        });
    }
}

function editApplication(appId) {
    // For now, just show a message - you can implement full edit functionality later
    showNotification('Edit functionality coming soon!', 'info');
}

// Set default date to today
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('input[name="applied_date"]');
    if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
});
</script>
{{end}}