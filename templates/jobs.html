{{block "content" .}}


<div class="page-header with-actions">
    <div>
        <h1>Job Board</h1>
        <p class="subtitle">Find your next cybersecurity role</p>
    </div>
    <button class="btn btn-primary" onclick="startScraping()">
        <span class="loading hidden" id="scrapingLoader"></span>
        Refresh Jobs
    </button>
</div>

<!-- Filters -->
<div class="filters-card">
    <div class="filters-grid">
        <div class="filter-group">
            <label>Min Score</label>
            <select class="form-select" onchange="filterJobs()">
                <option value="">All Scores</option>
                <option value="80" {{if eq .ScoreFilter "80"}}selected{{end}}>80%+</option>
                <option value="60" {{if eq .ScoreFilter "60"}}selected{{end}}>60%+</option>
                <option value="40" {{if eq .ScoreFilter "40"}}selected{{end}}>40%+</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Skills</label>
            <select class="form-select" onchange="filterJobs()">
                <option value="">All Skills</option>
                <option value="aws" {{if eq .SkillFilter "aws"}}selected{{end}}>AWS</option>
                <option value="python" {{if eq .SkillFilter "python"}}selected{{end}}>Python</option>
                <option value="fortinet" {{if eq .SkillFilter "fortinet"}}selected{{end}}>Fortinet</option>
                <option value="siem" {{if eq .SkillFilter "siem"}}selected{{end}}>SIEM</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Company</label>
            <input type="text" class="form-input" placeholder="Filter by company..." 
                   value="{{.CompanyFilter}}" oninput="filterJobs()">
        </div>
        
        <div class="filter-group">
            <label>Location</label>
            <select class="form-select" onchange="filterJobs()">
                <option value="">All Locations</option>
                <option value="nairobi" {{if eq .LocationFilter "nairobi"}}selected{{end}}>Nairobi</option>
                <option value="remote" {{if eq .LocationFilter "remote"}}selected{{end}}>Remote</option>
            </select>
        </div>
    </div>
</div>

<!-- Jobs List -->
<div class="jobs-list">
    {{range .Jobs}}
    <div class="job-card {{if gt .Score 80}}high-score{{else if gt .Score 60}}medium-score{{else}}low-score{{end}}">
        <div class="job-content">
            <div class="job-main">
                <h3 class="job-title">{{.Title}}</h3>
                <p class="job-company">{{.Company}} ‚Ä¢ {{.Location}}</p>
                <div class="job-meta">
                    <span class="job-source">{{.Source}}</span>
                    <span class="job-date">{{.PostedDate}}</span>
                    {{if .SalaryRange}}<span class="job-salary">{{.SalaryRange}}</span>{{end}}
                    {{if .Experience}}<span class="job-experience">{{.Experience}}</span>{{end}}
                </div>
                
                {{if .Description}}
                <p class="job-description">{{truncate .Description 200}}</p>
                {{end}}
                
                <div class="job-skills">
                    {{range .Skills}}
                    <span class="skill-tag">{{.}}</span>
                    {{end}}
                </div>
                
                {{if .TechStack}}
                <div class="job-tech">
                    {{range .TechStack}}
                    <span class="tech-tag">{{.}}</span>
                    {{end}}
                </div>
                {{end}}
            </div>
            
            <div class="job-actions">
                <div class="score-badge {{if gt .Score 80}}score-high{{else if gt .Score 60}}score-medium{{else}}score-low{{end}}">
                    {{.Score}}% Match
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-sm" 
                            onclick="applyForJob('{{.ID}}', '{{.Title}}', '{{.Company}}')">
                        Quick Apply
                    </button>
                    <button class="btn btn-outline btn-sm" 
                            onclick="analyzeJob('{{.ID}}', '{{.Title}}', '{{.Company}}', `{{.Description}}`)">
                        Analyze
                    </button>
                    {{if .URL}}
                    <a href="{{.URL}}" target="_blank" class="btn btn-outline btn-sm">
                        View Original
                    </a>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
    {{else}}
    <div class="empty-state">
        <h3>No jobs found</h3>
        <p>Try refreshing the job listings or adjusting your filters</p>
        <button class="btn btn-primary" onclick="startScraping()">Scrape Jobs</button>
    </div>
    {{end}}
</div>

<!-- Pagination -->
{{if .HasNext}}
<div class="pagination">
    <button class="btn btn-outline" onclick="loadMore()">Load More</button>
</div>
{{end}}

<!-- Analysis Modal -->
<div id="analysisModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Job Analysis</h3>
            <button class="modal-close" onclick="closeAnalysis()">√ó</button>
        </div>
        <div class="modal-body">
            <div id="analysisResults"></div>
        </div>
    </div>
</div>

<script>
function startScraping() {
    const loader = document.getElementById('scrapingLoader');
    const button = event.target;
    
    loader.classList.remove('hidden');
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span> Scraping...';
    
    fetch('/jobs/scrape')
        .then(response => response.json())
        .then(data => {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 3000);
        })
        .catch(error => {
            showNotification('Scraping failed: ' + error.message, 'error');
        })
        .finally(() => {
            loader.classList.add('hidden');
            button.disabled = false;
            button.innerHTML = 'Refresh Jobs';
        });
}

function filterJobs() {
    const minScore = document.querySelector('select').value;
    const searchTerm = document.querySelector('input').value.toLowerCase();
    
    document.querySelectorAll('.job-card').forEach(card => {
        const score = parseInt(card.querySelector('.score-badge').textContent);
        const company = card.querySelector('.job-company').textContent.toLowerCase();
        const title = card.querySelector('.job-title').textContent.toLowerCase();
        
        const scoreMatch = !minScore || score >= parseInt(minScore);
        const searchMatch = !searchTerm || company.includes(searchTerm) || title.includes(searchTerm);
        
        card.style.display = scoreMatch && searchMatch ? 'block' : 'none';
    });
}

function analyzeJob(jobId, title, company, description) {
    const modal = document.getElementById('analysisModal');
    const results = document.getElementById('analysisResults');
    
    results.innerHTML = `
        <div class="loading-state">
            <div class="loading"></div>
            <p>Analyzing job fit...</p>
        </div>
    `;
    
    modal.classList.add('active');
    
    fetch('/analyze-skills', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_description: description
        })
    })
    .then(response => response.json())
    .then(analysis => {
        results.innerHTML = `
            <div class="analysis-results">
                <div class="analysis-header">
                    <div class="fit-score">
                        <div class="score-circle">${analysis.fit_score}%</div>
                        <div>
                            <h4>Overall Fit Score</h4>
                            <p>Based on skill matching</p>
                        </div>
                    </div>
                </div>
                
                <div class="skills-comparison">
                    <div class="skills-section matching">
                        <h4>‚úÖ Matching Skills</h4>
                        <div class="skills-list">
                            ${analysis.matching_skills.map(skill => 
                                `<span class="skill-badge match">${skill}</span>`
                            ).join('')}
                            ${analysis.matching_skills.length === 0 ? '<p class="no-skills">No matching skills found</p>' : ''}
                        </div>
                    </div>
                    
                    <div class="skills-section missing">
                        <h4>‚ùå Missing Skills</h4>
                        <div class="skills-list">
                            ${analysis.missing_skills.map(skill => 
                                `<span class="skill-badge missing">${skill}</span>`
                            ).join('')}
                            ${analysis.missing_skills.length === 0 ? '<p class="no-skills">No missing skills - great fit!</p>' : ''}
                        </div>
                    </div>
                </div>
                
                ${analysis.recommendations && analysis.recommendations.length ? `
                <div class="recommendations">
                    <h4>üí° Recommendations</h4>
                    <ul>
                        ${analysis.recommendations.map(rec => 
                            `<li>${rec}</li>`
                        ).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div class="analysis-actions">
                    <button class="btn btn-primary" onclick="generateCoverLetter('${title}', '${company}', \`${description}\`)">
                        Generate Cover Letter
                    </button>
                    <button class="btn btn-outline" onclick="closeAnalysis()">Close</button>
                </div>
            </div>
        `;
    })
    .catch(error => {
        results.innerHTML = `
            <div class="error-state">
                <p>Analysis failed: ${error.message}</p>
            </div>
        `;
    });
}

function closeAnalysis() {
    document.getElementById('analysisModal').classList.remove('active');
}

function generateCoverLetter(title, company, description) {
    fetch('/cover-letter', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_title: title,
            company: company,
            job_description: description,
            user_profile: 'Cybersecurity professional with experience in Fortinet, AWS security, SIEM, and cloud security.'
        })
    })
    .then(response => response.json())
    .then(data => {
        const coverLetter = data.cover_letter || data.data.cover_letter;
        showCoverLetter(coverLetter, title, company);
    })
    .catch(error => {
        showNotification('Failed to generate cover letter: ' + error.message, 'error');
    });
}

function showCoverLetter(content, title, company) {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Cover Letter: ${title} at ${company}</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="cover-letter-content">
                    <pre>${content}</pre>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="copyToClipboard('${content.replace(/'/g, "\\'")}')">
                        Copy to Clipboard
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Cover letter copied to clipboard!', 'success');
    });
}

function loadMore() {
    const currentPage = {{.CurrentPage}};
    window.location.href = `/jobs?page=${currentPage + 1}`;
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
});
</script>
{{end}}